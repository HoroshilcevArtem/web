<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Мини-приложение</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f9f9f9;
    }

    #profile {
      margin-top: 50px;
    }

    img {
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }

    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }

    #status {
      margin-top: 15px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="profile">Загрузка...</div>
  <button id="addBtn">➕ Увеличить баланс</button>
  <div id="status">Проверка сервера...</div>

  <script>
    const tg = window.Telegram.WebApp;
    const user = tg.initDataUnsafe.user;

    // сюда вставь свой ngrok-URL
    const API_URL = "https://1fc296b1e8ee.ngrok-free.app";  

    let lastBalance = null;

    function renderProfile(balance) {
      if (user) {
        document.getElementById("profile").innerHTML =
          '<img src="${user.photo_url || "https://t.me/i/userpic/320/" + user.id + ".jpg"}" width="120" height="120" alt="Аватар"> <h2>${user.first_name} (ID: ${user.id})</h2> <p>Имя пользователя: @${user.username || "Не указано"}</p> <p>Баланс: ${balance}</p>';
      } else {
        document.getElementById("profile").innerText = "Данные пользователя не найдены.";
      }
    }

    function checkBalance() {
      fetch('${API_URL}/get_balance?id=${user.id}')
        .then(r => r.json())
        .then(data => {
          if (lastBalance !== data.balance) {
            lastBalance = data.balance;
            renderProfile(data.balance);
          }
          document.getElementById("status").innerText = "✅ Сервер онлайн";
        })
        .catch(err => {
          console.error("Ошибка запроса:", err);
          document.getElementById("status").innerText = "❌ Сервер недоступен";
        });
    }

    document.getElementById("addBtn").addEventListener("click", () => {
      fetch('${API_URL}/add_balance?id=${user.id}, {method: "POST"}')
        .then(r => r.json())
        .then(data => {
          lastBalance = data.balance;
          renderProfile(data.balance);
        })
        .catch(err => {
          console.error("Ошибка при увеличении баланса:", err);
          document.getElementById("status").innerText = "❌ Ошибка при обновлении";
        });
    });

    // Проверка баланса каждые 1 сек
    setInterval(checkBalance, 1000);

    tg.expand();
  </script>
</body>
</html>