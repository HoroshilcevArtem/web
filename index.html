<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        .button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        #status {
            margin-top: 20px;
            font-size: 14px;
            color: #333;
        }
    </style>
</head>
<body>
    <button class="button" id="sendBtn" onclick="sendToBot('1000')">1000</button>
    <div id="status"></div>

    <script>
        const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
        const sendBtn = document.getElementById('sendBtn');
        const statusDiv = document.getElementById('status');

        // Если открыто как локальный файл — это точно не Telegram
        const isLocalFile = location.protocol === 'file:';

        // Надёжная проверка: initData — непустая строка ИЛИ initDataUnsafe.user.id существует
        const hasInitDataString = !!(tg && typeof tg.initData === 'string' && tg.initData.trim().length > 0);
        const hasInitDataUnsafeUser = !!(tg && tg.initDataUnsafe && tg.initDataUnsafe.user && (tg.initDataUnsafe.user.id || tg.initDataUnsafe.user.id === 0));
        const isTelegram = !isLocalFile && (hasInitDataString || hasInitDataUnsafeUser);

        if (tg) {
            try { tg.ready(); } catch (e) { console.warn('tg.ready() error', e); }
            try { tg.expand(); } catch (e) { /* не критично */ }
        }

        // Диагностика
        console.log('location.protocol:', location.protocol);
        console.log('tg object:', tg);
        console.log('hasInitDataString:', hasInitDataString);
        console.log('hasInitDataUnsafeUser:', hasInitDataUnsafeUser);
        console.log('isTelegram(final):', isTelegram);

        if (isTelegram) {
            statusDiv.innerText = "Мини-приложение запущено внутри Telegram.";
            sendBtn.disabled = false;
        } else {
            statusDiv.innerText = "Невозможно отправить данные — откройте мини‑приложение внутри Telegram (не открывайте локально).";
            sendBtn.disabled = true;
        }

        function sendToBot(value) {
            if (isTelegram && tg && typeof tg.sendData === 'function') {
                try {
                    // Блокируем кнопку, чтобы избежать повторных нажатий
                    sendBtn.disabled = true;
                    statusDiv.innerText = "Отправка данных в бот: " + value;
                    console.log('Отправка tg.sendData:', value);
                    tg.sendData(value);

                    // Дадим время на отправку данных, затем закроем (если нужно).
                    // Некоторые клиенты требуют небольшой паузы перед закрытием.
                    const CLOSE_DELAY_MS = 700;
                    setTimeout(() => {
                        try {
                            if (typeof tg.close === 'function') {
                                tg.close();
                                console.log('tg.close() вызван после задержки', CLOSE_DELAY_MS);
                                statusDiv.innerText = "Данные отправлены, мини‑приложение закрывается...";
                            } else {
                                console.log('tg.close() не доступен');
                                statusDiv.innerText = "Данные отправлены (tg.close() недоступен).";
                            }
                        } catch (closeErr) {
                            console.warn('Ошибка при вызове tg.close():', closeErr);
                            statusDiv.innerText = "Данные отправлены (ошибка при закрытии).";
                        }
                    }, CLOSE_DELAY_MS);

                } catch (err) {
                    console.error('Ошибка при sendData:', err);
                    statusDiv.innerText = "Ошибка при отправке данных: " + err;
                    sendBtn.disabled = false;
                }
            } else {
                statusDiv.innerText = "Данные не отправлены: приложение не запущено в Telegram или sendData недоступен.";
                console.warn('sendData недоступен, не отправлено:', value);
            }
        }
    </script>
</body>
</html>
